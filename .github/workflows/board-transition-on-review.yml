name: Board Transition On Review

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: read
  issues: write
  repository-projects: write

jobs:
  transition-ticket:
    if: ${{ github.event.review.state == 'approved' || github.event.review.state == 'changes_requested' }}
    runs-on: ubuntu-latest
    env:
      PROJECT_OWNER: ${{ vars.OMNI_PROJECT_OWNER }}
      PROJECT_NUMBER: ${{ vars.OMNI_PROJECT_NUMBER }}
      STATUS_FIELD_ID: ${{ vars.OMNI_STATUS_FIELD_ID }}
      STATUS_OPTION_TODO: ${{ vars.OMNI_STATUS_OPTION_TODO }}
      STATUS_OPTION_IN_PROGRESS: ${{ vars.OMNI_STATUS_OPTION_IN_PROGRESS }}
      STATUS_OPTION_DONE: ${{ vars.OMNI_STATUS_OPTION_DONE }}
    steps:
      - name: Validate board config
        run: |
          test -n "${PROJECT_OWNER}" || (echo "Missing repo variable: OMNI_PROJECT_OWNER" && exit 1)
          test -n "${PROJECT_NUMBER}" || (echo "Missing repo variable: OMNI_PROJECT_NUMBER" && exit 1)
          test -n "${STATUS_FIELD_ID}" || (echo "Missing repo variable: OMNI_STATUS_FIELD_ID" && exit 1)
          test -n "${STATUS_OPTION_TODO}" || (echo "Missing repo variable: OMNI_STATUS_OPTION_TODO" && exit 1)
          test -n "${STATUS_OPTION_IN_PROGRESS}" || (echo "Missing repo variable: OMNI_STATUS_OPTION_IN_PROGRESS" && exit 1)
          test -n "${STATUS_OPTION_DONE}" || (echo "Missing repo variable: OMNI_STATUS_OPTION_DONE" && exit 1)

      - name: Resolve linked ticket and target state
        id: routing
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const patterns = [
              /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/ig,
              /(?:ticket|issue)\s*[:#]\s*#?(\d+)/ig
            ];
            let issueNumber = null;
            for (const pattern of patterns) {
              const match = pattern.exec(body);
              if (match) {
                issueNumber = Number(match[1]);
                break;
              }
            }
            if (!issueNumber) {
              core.setFailed("PR must reference a ticket, e.g. `Closes #123` or `Ticket: #123`.");
              return;
            }

            const reviewState = context.payload.review.state;
            const toState = reviewState === "approved" ? "Done" : "Todo";
            const optionId = reviewState === "approved"
              ? process.env.STATUS_OPTION_DONE
              : process.env.STATUS_OPTION_TODO;

            core.setOutput("issue_number", String(issueNumber));
            core.setOutput("to_state", toState);
            core.setOutput("option_id", optionId);

      - name: Move project ticket state
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.routing.outputs.issue_number }}
          TARGET_STATE: ${{ steps.routing.outputs.to_state }}
          TARGET_OPTION_ID: ${{ steps.routing.outputs.option_id }}
        with:
          script: |
            const owner = process.env.PROJECT_OWNER;
            const projectNumber = Number(process.env.PROJECT_NUMBER);
            const statusFieldId = process.env.STATUS_FIELD_ID;
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const targetState = process.env.TARGET_STATE;
            const targetOptionId = process.env.TARGET_OPTION_ID;
            const inProgressOptionId = process.env.STATUS_OPTION_IN_PROGRESS;

            async function getProject() {
              const query = `
                query($owner: String!, $number: Int!) {
                  user(login: $owner) { projectV2(number: $number) { id title } }
                  organization(login: $owner) { projectV2(number: $number) { id title } }
                }
              `;
              const result = await github.graphql(query, { owner, number: projectNumber });
              return result.user?.projectV2 || result.organization?.projectV2;
            }

            async function getProjectItems(projectId) {
              const items = [];
              let hasNextPage = true;
              let cursor = null;
              const query = `
                query($projectId: ID!, $cursor: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $cursor) {
                        pageInfo { hasNextPage endCursor }
                        nodes {
                          id
                          content {
                            ... on Issue { number title url }
                          }
                          fieldValues(first: 50) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                optionId
                                name
                                field {
                                  ... on ProjectV2FieldCommon { id name }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              while (hasNextPage) {
                const result = await github.graphql(query, { projectId, cursor });
                const page = result.node.items;
                items.push(...page.nodes);
                hasNextPage = page.pageInfo.hasNextPage;
                cursor = page.pageInfo.endCursor;
              }
              return items;
            }

            const project = await getProject();
            if (!project) core.setFailed(`Project #${projectNumber} not found for owner ${owner}.`);

            const items = await getProjectItems(project.id);
            const target = items.find((item) => item.content?.number === issueNumber);
            if (!target) {
              core.setFailed(`Issue #${issueNumber} is not on project board ${project.title}.`);
              return;
            }

            const currentStatus = (target.fieldValues?.nodes || []).find(
              (node) => node?.field?.id === statusFieldId
            );
            if (currentStatus?.optionId !== inProgressOptionId) {
              core.setFailed(
                `Issue #${issueNumber} is not in In Progress. Current status: '${currentStatus?.name || "unset"}'.`
              );
              return;
            }

            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `;
            await github.graphql(mutation, {
              projectId: project.id,
              itemId: target.id,
              fieldId: statusFieldId,
              optionId: targetOptionId
            });

            core.notice(`Moved issue #${issueNumber} to '${targetState}'.`);

      - name: Comment transition on ticket
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number("${{ steps.routing.outputs.issue_number }}");
            const toState = "${{ steps.routing.outputs.to_state }}";
            const reviewState = context.payload.review.state;
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `Board status updated to **${toState}**.`,
                ``,
                `- Trigger: PR #${prNumber} review submitted (${reviewState})`,
                `- Actor: @${context.actor}`,
                `- Workflow: ${context.workflow}`
              ].join("\n")
            });
