name: Board Status Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read
  issues: write
  repository-projects: read

jobs:
  enforce-board-status:
    runs-on: ubuntu-latest
    env:
      PROJECT_OWNER: ${{ vars.OMNI_PROJECT_OWNER }}
      PROJECT_NUMBER: ${{ vars.OMNI_PROJECT_NUMBER }}
      STATUS_FIELD_ID: ${{ vars.OMNI_STATUS_FIELD_ID }}
      EXPECTED_STATUS: In Progress
    steps:
      - name: Validate board config
        run: |
          test -n "${PROJECT_OWNER}" || (echo "Missing repo variable: OMNI_PROJECT_OWNER" && exit 1)
          test -n "${PROJECT_NUMBER}" || (echo "Missing repo variable: OMNI_PROJECT_NUMBER" && exit 1)
          test -n "${STATUS_FIELD_ID}" || (echo "Missing repo variable: OMNI_STATUS_FIELD_ID" && exit 1)

      - name: Resolve linked ticket
        id: ticket
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const patterns = [
              /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/ig,
              /(?:ticket|issue)\s*[:#]\s*#?(\d+)/ig
            ];
            let issueNumber = null;
            for (const pattern of patterns) {
              const match = pattern.exec(body);
              if (match) {
                issueNumber = Number(match[1]);
                break;
              }
            }
            if (!issueNumber) {
              core.setFailed("PR must reference a ticket, e.g. `Closes #123` or `Ticket: #123`.");
              return;
            }
            core.setOutput("issue_number", String(issueNumber));

      - name: Ensure ticket is In Progress on project board
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.ticket.outputs.issue_number }}
        with:
          script: |
            const owner = process.env.PROJECT_OWNER;
            const projectNumber = Number(process.env.PROJECT_NUMBER);
            const statusFieldId = process.env.STATUS_FIELD_ID;
            const expectedStatus = process.env.EXPECTED_STATUS;
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const query = `
              query($repoOwner: String!, $repoName: String!, $issueNumber: Int!) {
                repository(owner: $repoOwner, name: $repoName) {
                  issue(number: $issueNumber) {
                    projectItems(first: 100) {
                      nodes {
                        id
                        project {
                          id
                          number
                          title
                          owner {
                            ... on User { login }
                            ... on Organization { login }
                          }
                        }
                        fieldValues(first: 50) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              optionId
                              field {
                                ... on ProjectV2FieldCommon { id name }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query, {
              repoOwner: context.repo.owner,
              repoName: context.repo.repo,
              issueNumber
            });
            const projectItems = result.repository?.issue?.projectItems?.nodes || [];
            const target = projectItems.find((item) => (
              item?.project?.number === projectNumber &&
              (item?.project?.owner?.login || "").toLowerCase() === owner.toLowerCase()
            ));
            if (!target) {
              core.warning(
                `Unable to verify board linkage for issue #${issueNumber} on project #${projectNumber}. ` +
                "Project data may be inaccessible to the workflow token; skipping strict gate."
              );
              return;
            }

            const status = (target.fieldValues?.nodes || []).find(
              (node) => node?.field?.id === statusFieldId
            );
            const currentStatus = status?.name;
            if (currentStatus !== expectedStatus) {
              core.setFailed(
                `Issue #${issueNumber} status is '${currentStatus || "unset"}'. Expected '${expectedStatus}'.`
              );
              return;
            }

            core.notice(`Board status gate passed: Issue #${issueNumber} is '${currentStatus}'.`);
