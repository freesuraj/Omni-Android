default_platform(:android)

platform :android do
  desc "Required CI gate: lint + debug build + unit tests"
  lane :verify do
    gradle(task: "lintDebug")
    gradle(task: "assembleDebug")
    gradle(task: "testDebugUnitTest")
  end

  desc "Build screenshots artifact set for a PR"
  lane :screenshots_pr do |options|
    pr_number = (options[:pr] || ENV["PR_NUMBER"]).to_s.strip
    UI.user_error!("Pass PR number: fastlane android screenshots_pr pr:<PR_NUMBER>") if pr_number.empty?

    gradle(task: "assembleDebug")

    artifact_dir = "artifacts/pr/#{pr_number}/screenshots"
    sh("mkdir -p #{artifact_dir}")

    # Capture deterministic UI evidence directly from emulator to avoid flakiness from
    # instrumentation startup on CI hosts.
    sh <<~BASH
      set -euo pipefail
      APP_ID="com.suraj.apps.Doc2Quiz"
      APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
      ARTIFACT_DIR="#{artifact_dir}"
      ADB_BIN="$(command -v adb || true)"

      if [ -z "$ADB_BIN" ] && [ -n "${ANDROID_HOME:-}" ] && [ -x "${ANDROID_HOME}/platform-tools/adb" ]; then
        ADB_BIN="${ANDROID_HOME}/platform-tools/adb"
      fi

      if [ -z "$ADB_BIN" ] && [ -n "${ANDROID_SDK_ROOT:-}" ] && [ -x "${ANDROID_SDK_ROOT}/platform-tools/adb" ]; then
        ADB_BIN="${ANDROID_SDK_ROOT}/platform-tools/adb"
      fi

      if [ -z "$ADB_BIN" ]; then
        echo "adb binary not found in PATH/ANDROID_HOME/ANDROID_SDK_ROOT"
        exit 1
      fi

      run_with_timeout() {
        local seconds="$1"
        shift
        timeout "$seconds" "$@"
      }

      capture() {
        local path="$1"
        "$ADB_BIN" exec-out screencap -p > "$path"
      }

      if [ ! -f "$APK_PATH" ]; then
        echo "Expected APK missing at $APK_PATH"
        exit 1
      fi

      run_with_timeout 120 "$ADB_BIN" wait-for-device
      run_with_timeout 180 "$ADB_BIN" install -r "$APK_PATH"
      "$ADB_BIN" shell am force-stop "$APP_ID" >/dev/null 2>&1 || true
      run_with_timeout 60 "$ADB_BIN" shell monkey -p "$APP_ID" -c android.intent.category.LAUNCHER 1 1 >/dev/null 2>&1
      sleep 3

      capture "$ARTIFACT_DIR/library.png"

      # Open dashboard from Library screen.
      "$ADB_BIN" shell input tap 540 1150 >/dev/null 2>&1 || true
      sleep 2
      capture "$ARTIFACT_DIR/dashboard.png"

      # Open paywall from dashboard CTA.
      "$ADB_BIN" shell input tap 540 2045 >/dev/null 2>&1 || true
      sleep 2
      capture "$ARTIFACT_DIR/paywall.png"

      # Return to library then open settings.
      "$ADB_BIN" shell input keyevent 4 >/dev/null 2>&1 || true
      "$ADB_BIN" shell input keyevent 4 >/dev/null 2>&1 || true
      sleep 1
      "$ADB_BIN" shell input tap 1005 145 >/dev/null 2>&1 || true
      sleep 1
      capture "$ARTIFACT_DIR/settings.png"
    BASH

    if ENV["GITHUB_ACTIONS"] == "true"
      UI.message("Screenshots prepared in #{artifact_dir}")
    end
  end

  desc "Deploy release bundle to internal testing track (optional)"
  lane :internal do
    gradle(task: "bundleRelease")
    aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
    UI.user_error!("AAB path not found from Gradle output.") if aab_path.to_s.empty?

    if ENV["SUPPLY_JSON_KEY"].to_s.empty? && ENV["SUPPLY_JSON_KEY_FILE"].to_s.empty?
      UI.user_error!("Set SUPPLY_JSON_KEY or SUPPLY_JSON_KEY_FILE to deploy with fastlane supply.")
    end

    upload_to_play_store(
      track: "internal",
      aab: aab_path,
      json_key: ENV["SUPPLY_JSON_KEY_FILE"],
      json_key_data: ENV["SUPPLY_JSON_KEY"],
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
